stages:
    - test
    - build
    - misc
    - image
    - deploy

variables:
    CARGO_HOME: "$CI_PROJECT_DIR/.cargo"

    REDIS_DSN: redis://redis:6379/
    SQLX_OFFLINE: "true"

# Run tests on current stable Rust version
test:latest: &base_test
    image: rust:1.54-slim-buster
    stage: test
    services:
        - redis
    cache:
        paths:
            - .cargo/
        policy: pull-push
    before_script:
        - apt-get update -y
        - apt-get install -y wget libssl-dev pkg-config libavcodec-dev libavformat-dev libavutil-dev libavdevice-dev clang llvm python3 python3-pip

        - export RELEASE=$CI_COMMIT_SHA
    script:
        - cargo build --verbose
        - cargo test --verbose
        - cargo test --verbose -- --ignored

# Same as above, but nightly Rust
test:nightly:
    <<: *base_test
    image: rustlang/rust:nightly-slim
    allow_failure: true

build:
    <<: *base_test
    stage: build
    cache:
        policy: pull
    needs: ['test:latest']
    services: []
    artifacts:
        expire_in: 1 day
        paths:
            - ./foxbot/foxbot
            - ./foxbot-background-worker/foxbot-background-worker
    script:
        - cargo build --verbose --release --bin foxbot
        - mv ./target/release/foxbot ./foxbot/foxbot
        - cargo build --verbose --release --bin foxbot-background-worker
        - mv ./target/release/foxbot-background-worker ./foxbot-background-worker/foxbot-background-worker

misc:
    stage: misc
    image:
        name: gcr.io/kaniko-project/executor:debug
        entrypoint: [""]
    before_script:
        - mkdir -p /kaniko/.docker
        - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    needs: []
    script:
        - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE/base:$CI_COMMIT_SHA --destination $CI_REGISTRY_IMAGE/base:latest --cache=true

docker:
    stage: image
    image:
        name: gcr.io/kaniko-project/executor:debug
        entrypoint: [""]
    before_script:
        - mkdir -p /kaniko/.docker
        - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    needs: ['build', 'misc']
    script:
        - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/foxbot/Dockerfile --destination $CI_REGISTRY_IMAGE/bot:$CI_COMMIT_SHA --destination $CI_REGISTRY_IMAGE/bot:latest --cache=true
        - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/foxbot-background-worker/Dockerfile --destination $CI_REGISTRY_IMAGE/background-worker:$CI_COMMIT_SHA --destination $CI_REGISTRY_IMAGE/background-worker:latest --cache=true
